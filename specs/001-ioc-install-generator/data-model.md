# Data Model: IoC Install Generator

**Feature**: IoC Install Generator  
**Date**: 2025-01-27  
**Phase**: 1 - Design & Contracts

## Entities

### IIoCInstaller

**Purpose**: Interfaz común que deben implementar todos los módulos que desean registrar dependencias en el contenedor IoC.

**Definition**:
```csharp
public interface IIoCInstaller
{
    void Install(IIoCContainer container);
}
```

**Properties**:
- Ninguna (interfaz de comportamiento)

**Methods**:
- `Install(IIoCContainer container)`: Registra las dependencias del módulo en el contenedor IoC proporcionado

**Validation Rules**:
- Debe ser implementada por clases públicas
- La clase implementadora debe estar en un ensamblado referenciado por el proyecto host
- No puede ser una clase abstracta o estática (debe ser instanciable)

**Relationships**:
- Implementada por clases instaladoras en módulos referenciados
- Invocada por el código generado durante la inicialización

**State Transitions**: N/A (interfaz sin estado)

### IIoCContainer

**Purpose**: Abstracción genérica para contenedores IoC que permite compatibilidad con múltiples implementaciones.

**Definition**:
```csharp
public interface IIoCContainer
{
    void Register<TService, TImplementation>() 
        where TImplementation : TService;
    
    void Register<TService>(TService instance);
    
    void Register<TService>(Func<IIoCContainer, TService> factory);
}
```

**Properties**:
- Ninguna (interfaz de comportamiento)

**Methods**:
- `Register<TService, TImplementation>()`: Registra un tipo de servicio con su implementación
- `Register<TService>(TService instance)`: Registra una instancia singleton
- `Register<TService>(Func<IIoCContainer, TService> factory)`: Registra un factory para crear instancias

**Validation Rules**:
- `TImplementation` debe ser asignable a `TService`
- Las instancias y factories no pueden ser null

**Relationships**:
- Implementada por adaptadores para contenedores específicos (Autofac, Unity, etc.)
- Pasada como parámetro a `IIoCInstaller.Install()`
- Usada por el código generado para invocar instaladores

**State Transitions**: N/A (interfaz sin estado)

### InstallOrderAttribute

**Purpose**: Atributo para configurar el orden de ejecución de instaladores por ensamblado en la aplicación host.

**Definition**:
```csharp
[AttributeUsage(AttributeTargets.Class | AttributeTargets.Assembly, AllowMultiple = false)]
public class InstallOrderAttribute : Attribute
{
    public string[] AssemblyNames { get; }
    
    public InstallOrderAttribute(params string[] assemblyNames)
    {
        AssemblyNames = assemblyNames ?? throw new ArgumentNullException(nameof(assemblyNames));
    }
}
```

**Properties**:
- `AssemblyNames`: Array de nombres de ensamblados en el orden deseado de ejecución

**Validation Rules**:
- No puede ser null
- Los nombres de ensamblados deben corresponder a ensamblados referenciados
- Puede aplicarse a clase o assembly
- Si no se especifica, se usa orden de descubrimiento (arbitrario)

**Relationships**:
- Aplicado a la clase principal de la aplicación host
- Leído por el source generator durante la generación de código
- Usado para ordenar los instaladores en el código generado

**State Transitions**: N/A (atributo de metadatos)

### Generated Installer Loader (Código Generado)

**Purpose**: Clase estática generada por el source generator que contiene referencias a todos los instaladores y un método para cargarlos.

**Definition** (ejemplo generado):
```csharp
// <auto-generated />
namespace IoC.InstallGenerator.Generated
{
    public static class IoCInstallerLoader
    {
        public static void LoadAll(IIoCContainer container)
        {
            var errors = new List<Exception>();
            
            // Instaladores ordenados según configuración
            try
            {
                new ModuleA.ModuleAInstaller().Install(container);
            }
            catch (Exception ex)
            {
                errors.Add(new InstallerException("ModuleA.ModuleAInstaller", ex));
            }
            
            try
            {
                new ModuleB.ModuleBInstaller().Install(container);
            }
            catch (Exception ex)
            {
                errors.Add(new InstallerException("ModuleB.ModuleBInstaller", ex));
            }
            
            // ... más instaladores ...
            
            if (errors.Count > 0)
            {
                throw new AggregateException("One or more installers failed", errors);
            }
        }
    }
}
```

**Properties**:
- Ninguna (clase estática)

**Methods**:
- `LoadAll(IIoCContainer container)`: Ejecuta todos los instaladores en el orden configurado, captura excepciones y lanza `AggregateException` si hay fallos

**Validation Rules**:
- Generado automáticamente, no requiere validación manual
- Debe compilar sin errores
- Debe ser legible y debuggable

**Relationships**:
- Generado por el source generator
- Invocado por la aplicación host durante la inicialización
- Referencia tipos instaladores descubiertos

**State Transitions**: N/A (método estático sin estado)

## Relationships Summary

```
Application Host
    │
    ├── [InstallOrder] Attribute (configura orden)
    │
    └── References → Multiple Assemblies
            │
            └── Contains → IIoCInstaller Implementations
                    │
                    └── Uses → IIoCContainer (passed as parameter)
                            │
                            └── Implemented by → Container Adapters
                                    │
                                    └── Wraps → Specific IoC Containers (Autofac, Unity, etc.)

Source Generator
    │
    ├── Analyzes → Project References (direct + transitive)
    │
    ├── Discovers → IIoCInstaller Implementations
    │
    ├── Reads → [InstallOrder] Configuration
    │
    └── Generates → IoCInstallerLoader Class
            │
            └── Invokes → IIoCInstaller.Install() methods
```

## Data Flow

1. **Compilación**:
   - Source generator analiza referencias del proyecto host
   - Descubre clases que implementan `IIoCInstaller`
   - Lee atributo `[InstallOrder]` si existe
   - Genera clase `IoCInstallerLoader` con código estático

2. **Inicialización** (Runtime):
   - Aplicación host crea instancia de `IIoCContainer` (o adaptador)
   - Llama a `IoCInstallerLoader.LoadAll(container)`
   - Código generado instancia cada instalador y llama a `Install(container)`
   - Si hay errores, se acumulan y se lanza `AggregateException` al final

## Constraints

- Todos los instaladores deben ser clases públicas e instanciables
- El contenedor IoC debe implementar `IIoCContainer` (directamente o mediante adaptador)
- El orden de ejecución se respeta según `[InstallOrder]` o es arbitrario si no se especifica
- Las excepciones durante la instalación no detienen el proceso, se acumulan para lanzarse al final

