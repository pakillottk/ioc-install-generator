# Data Model: Actualización a .NET 8 e Incremental Source Generator

**Feature**: Actualización a .NET 8 e Incremental Source Generator  
**Date**: 2025-01-11  
**Phase**: 1 - Design & Contracts

## Entities

### IIoCInstaller

**Purpose**: Interfaz común que deben implementar todos los módulos que desean registrar dependencias en el contenedor IoC.

**Definition**:
```csharp
public interface IIoCInstaller
{
    void Install(IIoCContainer container);
}
```

**Properties**:
- Ninguna (interfaz de comportamiento)

**Methods**:
- `Install(IIoCContainer container)`: Registra las dependencias del módulo en el contenedor IoC proporcionado

**Validation Rules**:
- Debe ser implementada por clases públicas
- La clase implementadora debe estar en un ensamblado referenciado por el proyecto host
- No puede ser una clase abstracta o estática (debe ser instanciable)

**Relationships**:
- Implementada por clases instaladoras en módulos referenciados
- Invocada por el código generado durante la inicialización

**State Transitions**: N/A (interfaz sin estado)

**Note**: Esta entidad no cambia con la migración a .NET 8. Se mantiene igual para preservar compatibilidad.

### IIoCContainer

**Purpose**: Abstracción genérica para contenedores IoC que permite compatibilidad con múltiples implementaciones.

**Definition**:
```csharp
public interface IIoCContainer
{
    void Register<TService, TImplementation>() 
        where TImplementation : TService;
    
    void Register<TService>(TService instance);
    
    void Register<TService>(Func<IIoCContainer, TService> factory);
}
```

**Properties**:
- Ninguna (interfaz de comportamiento)

**Methods**:
- `Register<TService, TImplementation>()`: Registra un tipo de servicio con su implementación
- `Register<TService>(TService instance)`: Registra una instancia singleton
- `Register<TService>(Func<IIoCContainer, TService> factory)`: Registra un factory para crear instancias

**Validation Rules**:
- `TImplementation` debe ser asignable a `TService`
- Las instancias y factories no pueden ser null

**Relationships**:
- Implementada por adaptadores para contenedores específicos (Autofac, Unity, etc.)
- Pasada como parámetro a `IIoCInstaller.Install()`
- Usada por el código generado para invocar instaladores

**State Transitions**: N/A (interfaz sin estado)

**Note**: Esta entidad no cambia con la migración a .NET 8. Se mantiene igual para preservar compatibilidad.

### InstallOrderAttribute

**Purpose**: Atributo para configurar el orden de ejecución de instaladores por ensamblado en la aplicación host.

**Definition**:
```csharp
[AttributeUsage(AttributeTargets.Class | AttributeTargets.Assembly, AllowMultiple = false)]
public class InstallOrderAttribute : Attribute
{
    public string[] AssemblyNames { get; }
    
    public InstallOrderAttribute(params string[] assemblyNames)
    {
        AssemblyNames = assemblyNames ?? throw new ArgumentNullException(nameof(assemblyNames));
    }
}
```

**Properties**:
- `AssemblyNames`: Array de nombres de ensamblados en el orden deseado de ejecución

**Validation Rules**:
- No puede ser null
- Los nombres de ensamblados deben corresponder a ensamblados referenciados
- Puede aplicarse a clase o assembly
- Si no se especifica, se usa orden de descubrimiento (arbitrario)

**Relationships**:
- Aplicado a la clase principal de la aplicación host
- Leído por el source generator durante la generación de código
- Usado para ordenar los instaladores en el código generado

**State Transitions**: N/A (atributo de metadatos)

**Note**: Esta entidad no cambia con la migración a .NET 8. Se mantiene igual para preservar compatibilidad.

### IoCInstallerLoaderAttribute

**Purpose**: Atributo que marca clases donde el generador debe generar código para cargar instaladores.

**Definition**:
```csharp
[AttributeUsage(AttributeTargets.Class, AllowMultiple = false)]
public class IoCInstallerLoaderAttribute : Attribute
{
}
```

**Properties**:
- Ninguna (atributo marcador)

**Validation Rules**:
- Debe aplicarse a una clase parcial
- La clase debe ser pública o interna
- Solo se puede aplicar una vez por clase

**Relationships**:
- Aplicado a clases donde se desea generar el método `LoadAll`
- Detectado por el generador incremental usando `SyntaxProvider`
- Usado para determinar dónde generar código

**State Transitions**: N/A (atributo de metadatos)

**Note**: Esta entidad no cambia con la migración a .NET 8. Se mantiene igual para preservar compatibilidad.

### Generated Installer Loader (Código Generado)

**Purpose**: Clase parcial estática generada por el source generator incremental que contiene referencias a todos los instaladores y un método para cargarlos.

**Definition** (ejemplo generado):
```csharp
// <auto-generated />
namespace Demo.Host
{
    public static partial class Loader
    {
        public static void LoadAll(IIoCContainer container)
        {
            var errors = new List<Exception>();
            
            // Instaladores ordenados según configuración
            try
            {
                new ModuleA.ModuleAInstaller().Install(container);
            }
            catch (Exception ex)
            {
                errors.Add(new InstallerException("ModuleA.ModuleAInstaller", ex));
            }
            
            try
            {
                new ModuleB.ModuleBInstaller().Install(container);
            }
            catch (Exception ex)
            {
                errors.Add(new InstallerException("ModuleB.ModuleBInstaller", ex));
            }
            
            // ... más instaladores ...
            
            if (errors.Count > 0)
            {
                throw new AggregateException("One or more installers failed", errors);
            }
        }
    }
}
```

**Properties**:
- Ninguna (clase estática)

**Methods**:
- `LoadAll(IIoCContainer container)`: Ejecuta todos los instaladores en el orden configurado, captura excepciones y lanza `AggregateException` si hay fallos

**Validation Rules**:
- Generado automáticamente por el generador incremental, no requiere validación manual
- Debe compilar sin errores
- Debe ser legible y debuggable
- El código generado debe ser idéntico al generado por la versión anterior (ISourceGenerator)

**Relationships**:
- Generado por el source generator incremental (IIncrementalGenerator)
- Invocado por la aplicación host durante la inicialización
- Referencia tipos instaladores descubiertos

**State Transitions**: N/A (método estático sin estado)

**Note**: El código generado no cambia con la migración. Solo cambia la implementación interna del generador (de ISourceGenerator a IIncrementalGenerator), pero el código generado debe ser idéntico.

## Relationships Summary

```
Application Host (.NET 8)
    │
    ├── [IoCInstallerLoader] Attribute (marca clase para generación)
    │
    ├── [InstallOrder] Attribute (configura orden)
    │
    └── References → Multiple Assemblies (.NET 8)
            │
            └── Contains → IIoCInstaller Implementations
                    │
                    └── Uses → IIoCContainer (passed as parameter)
                            │
                            └── Implemented by → Container Adapters
                                    │
                                    └── Wraps → Specific IoC Containers (Autofac, Unity, etc.)

Incremental Source Generator (.NET 8)
    │
    ├── Uses → IIncrementalGenerator (nuevo en .NET 8)
    │
    ├── Pipeline Incremental:
    │   ├── SyntaxProvider → Finds [IoCInstallerLoader] classes
    │   ├── CompilationProvider → Analyzes types implementing IIoCInstaller
    │   └── Combine → Generates code for each loader class
    │
    ├── Analyzes → Project References (direct + transitive)
    │
    ├── Discovers → IIoCInstaller Implementations
    │
    ├── Reads → [InstallOrder] Configuration
    │
    └── Generates → Partial Class with LoadAll method
            │
            └── Invokes → IIoCInstaller.Install() methods
```

## Data Flow

1. **Compilación (Incremental)**:
   - Source generator incremental analiza referencias del proyecto host usando pipeline incremental
   - Descubre clases que implementan `IIoCInstaller` usando `CompilationProvider`
   - Encuentra clases con `[IoCInstallerLoader]` usando `SyntaxProvider`
   - Lee atributo `[InstallOrder]` si existe
   - Genera clase parcial con método `LoadAll` con código estático
   - Caching automático: solo reprocesa cuando cambian los inputs relevantes

2. **Inicialización** (Runtime):
   - Aplicación host crea instancia de `IIoCContainer` (o adaptador)
   - Llama a `Loader.LoadAll(container)` (método generado en clase parcial)
   - Código generado instancia cada instalador y llama a `Install(container)`
   - Si hay errores, se acumulan y se lanza `AggregateException` al final

## Constraints

- Todos los instaladores deben ser clases públicas e instanciables
- El contenedor IoC debe implementar `IIoCContainer` (directamente o mediante adaptador)
- El orden de ejecución se respeta según `[InstallOrder]` o es arbitrario si no se especifica
- Las excepciones durante la instalación no detienen el proceso, se acumulan para lanzarse al final
- El código generado debe ser idéntico al generado por la versión anterior (ISourceGenerator)
- Todos los proyectos deben usar .NET 8.0 como TargetFramework (excepto posiblemente Abstractions que puede usar multi-targeting)

## Changes from Previous Version

- **Generador**: Cambia de `ISourceGenerator` a `IIncrementalGenerator`
- **Pipeline**: Usa pipeline incremental con `SyntaxProvider` y `CompilationProvider` en lugar de `ISyntaxReceiver`
- **Caching**: Aprovecha caching automático del generador incremental
- **TargetFramework**: Todos los proyectos actualizados a net8.0
- **API Pública**: Sin cambios - todas las interfaces y atributos se mantienen igual
- **Código Generado**: Idéntico al anterior - solo cambia la implementación interna del generador

